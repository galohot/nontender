<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Kemenlu Data - Full Enhanced</title>

    <!-- Favicon -->
    <link
      rel="icon"
      href="https://lh3.googleusercontent.com/d/1YJ5QUeb-ekUYZbXIK_WuBWNi-RvhC40o"
      type="image/png"
    />

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Minimal inline Tailwind config (optional) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              kemenlu: {
                navy: {
                  500: "#3C59A7",
                },
                red: {
                  500: "#EF4444",
                },
                gold: {
                  500: "#F59E0B",
                },
                green: {
                  500: "#22C55E",
                },
              },
            },
          },
        },
      };
    </script>

    <!-- Vue 3 (standalone) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  </head>

  <body class="bg-gray-50 text-gray-800">
    <div id="app" class="min-h-screen flex flex-col">
      <!-- Navbar -->
      <nav class="bg-white shadow z-10">
        <div
          class="container mx-auto px-4 py-2 flex items-center justify-between"
        >
          <!-- Left: Logo & Title -->
          <div class="flex items-center space-x-3">
            <!-- Icon -->
            <img
              src="https://lh3.googleusercontent.com/d/1NY5Ncxw9q2zWS5OH2QAMVbkzKDJT4wl0"
              alt="Kemenlu Logo"
              class="h-10 w-10 object-cover"
            />
            <!-- Title -->
            <h1 class="text-lg font-semibold text-kemenlu-navy-500">
              Kemenlu Data Dashboard
            </h1>
          </div>

          <!-- Right: Loading Indicator -->
          <div v-if="isLoading" class="flex items-center space-x-2">
            <svg
              class="animate-spin h-5 w-5 text-kemenlu-navy-500"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v8H4z"
              ></path>
            </svg>
            <span class="text-sm text-gray-500">Fetching Data...</span>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="container mx-auto flex-1 px-4 py-6">
        <!-- Filters -->
        <div class="bg-white p-4 shadow rounded-lg mb-6">
          <div
            class="flex flex-col lg:flex-row lg:items-end lg:space-x-4 space-y-4 lg:space-y-0"
          >
            <!-- Dropdown Filter for pusat_perwakilan -->
            <div class="w-full lg:w-1/4">
              <label
                for="pusatFilter"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Filter Pusat/Perwakilan</label
              >
              <select
                id="pusatFilter"
                v-model="selectedPusatPerwakilan"
                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-kemenlu-navy-500 focus:ring-kemenlu-navy-500 text-sm"
              >
                <option value="">All</option>
                <option
                  v-for="(val, idx) in uniquePusatPerwakilan"
                  :key="idx"
                  :value="val"
                >
                  {{ val }}
                </option>
              </select>
            </div>

            <!-- Searchable dropdown for satker_alias (via datalist) -->
            <div class="w-full lg:w-1/4">
              <label
                for="satkerAliasInput"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Searchable Satker Alias</label
              >
              <!-- Using <datalist> for a searchable “dropdown” -->
              <input
                type="text"
                id="satkerAliasInput"
                list="satkerAliasList"
                v-model="selectedSatkerAlias"
                placeholder="Type alias or choose"
                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-kemenlu-navy-500 focus:ring-kemenlu-navy-500 text-sm"
              />
              <datalist id="satkerAliasList">
                <!-- We'll treat empty string as "All" if user clears the input -->
                <option value="">All</option>
                <option
                  v-for="(alias, idx) in uniqueSatkerAliases"
                  :key="idx"
                  :value="alias"
                />
              </datalist>
            </div>

            <!-- Dropdown filter for status (Belum / Sudah) => second API data -->
            <div class="w-full lg:w-1/4">
              <label
                for="statusFilter"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Status Pencatatan</label
              >
              <select
                id="statusFilter"
                v-model="selectedStatus"
                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-kemenlu-navy-500 focus:ring-kemenlu-navy-500 text-sm"
              >
                <option value="">All</option>
                <option value="0">Belum</option>
                <option value="1">Sudah</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Cards (Summary) -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
          <!-- Total Tercatat (raw integer) -->
          <div class="bg-white shadow rounded-lg p-4 flex flex-col">
            <span class="text-sm font-semibold text-gray-500 mb-1">
              Total Tercatat
            </span>
            <span class="text-2xl font-bold text-gray-800">
              {{ cardTotalTercatat }}
            </span>
          </div>

          <!-- Total Paket SIRUP (thousand separator) -->
          <div class="bg-white shadow rounded-lg p-4 flex flex-col">
            <span class="text-sm font-semibold text-gray-500 mb-1">
              Total Paket SIRUP
            </span>
            <span class="text-2xl font-bold text-gray-800">
              {{ formatNumber(cardTotalPaketSirup) }}
            </span>
          </div>

          <!-- Rata-rata Persentase (0.23 => 23.00%) -->
          <div class="bg-white shadow rounded-lg p-4 flex flex-col">
            <span class="text-sm font-semibold text-gray-500 mb-1">
              Rata-rata Persentase
            </span>
            <span class="text-2xl font-bold text-gray-800">
              {{ cardRataPersentase }}%
            </span>
          </div>

          <!-- Pagu SIRUP (IDR currency format) -->
          <div class="bg-white shadow rounded-lg p-4 flex flex-col">
            <span class="text-sm font-semibold text-gray-500 mb-1">
              Pagu SiRUP
            </span>
            <span class="text-2xl font-bold text-gray-800">
              {{ formatRupiah(cardPaguSirup) }}
            </span>
          </div>

          <!-- Pagu Realisasi (IDR currency format) -->
          <div class="bg-white shadow rounded-lg p-4 flex flex-col">
            <span class="text-sm font-semibold text-gray-500 mb-1">
              Pagu Realisasi
            </span>
            <span class="text-2xl font-bold text-gray-800">
              {{ formatRupiah(cardPaguRealisasi) }}
            </span>
          </div>
        </div>

        <!-- Top 5 (Satker, Country, Region) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
          <!-- Top 5 Satker by Average Percentage -->
          <div class="bg-white shadow rounded-lg p-4">
            <h2 class="text-lg font-semibold mb-2">Top 5 Satker by %</h2>
            <table class="min-w-full text-sm">
              <thead>
                <tr class="border-b">
                  <th class="py-2 text-left">Satker Alias</th>
                  <th class="py-2 text-right">Avg. %</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  v-for="(item, index) in topSatker"
                  :key="index"
                  class="border-b last:border-0"
                >
                  <td class="py-2">{{ item.key }}</td>
                  <td class="py-2 text-right">
                    {{ (item.avg * 100).toFixed(2) }}%
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Top 5 Country by Average Percentage -->
          <div class="bg-white shadow rounded-lg p-4">
            <h2 class="text-lg font-semibold mb-2">Top 5 Country by %</h2>
            <table class="min-w-full text-sm">
              <thead>
                <tr class="border-b">
                  <th class="py-2 text-left">Country</th>
                  <th class="py-2 text-right">Avg. %</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  v-for="(item, index) in topCountries"
                  :key="index"
                  class="border-b last:border-0"
                >
                  <td class="py-2">{{ item.key }}</td>
                  <td class="py-2 text-right">
                    {{ (item.avg * 100).toFixed(2) }}%
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Top 5 Region by Average Percentage -->
          <div class="bg-white shadow rounded-lg p-4">
            <h2 class="text-lg font-semibold mb-2">Top 5 Region by %</h2>
            <table class="min-w-full text-sm">
              <thead>
                <tr class="border-b">
                  <th class="py-2 text-left">Region</th>
                  <th class="py-2 text-right">Avg. %</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  v-for="(item, index) in topRegions"
                  :key="index"
                  class="border-b last:border-0"
                >
                  <td class="py-2">{{ item.key }}</td>
                  <td class="py-2 text-right">
                    {{ (item.avg * 100).toFixed(2) }}%
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Paginated, Sortable Table for NonTender Detail (Second API) -->
        <div class="bg-white shadow rounded-lg p-4">
          <div
            class="flex flex-col space-y-2 mb-4 md:flex-row md:items-center md:justify-between md:space-y-0"
          >
            <h2 class="text-lg font-semibold">NonTender Detail Table</h2>

            <!-- Page size selection -->
            <div class="flex items-center space-x-2">
              <label for="pageSize" class="text-sm">Rows per page:</label>
              <select
                id="pageSize"
                v-model.number="pageSize"
                class="rounded-md border-gray-300 text-sm focus:border-kemenlu-navy-500 focus:ring-kemenlu-navy-500"
              >
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
              </select>
            </div>
          </div>

          <!-- Table -->
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr
                  class="border-b bg-gray-100 text-gray-600 uppercase text-xs"
                >
                  <th
                    class="py-2 px-2 cursor-pointer"
                    @click="sortTable('tahun_anggaran')"
                  >
                    Tahun
                    <span v-if="sortField === 'tahun_anggaran'">
                      {{ sortOrder === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <th
                    class="py-2 px-2 cursor-pointer"
                    @click="sortTable('kd_satker_str')"
                  >
                    Kd Satker
                    <span v-if="sortField === 'kd_satker_str'">
                      {{ sortOrder === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <th
                    class="py-2 px-2 cursor-pointer"
                    @click="sortTable('nama_satker')"
                  >
                    Nama Satker
                    <span v-if="sortField === 'nama_satker'">
                      {{ sortOrder === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <th class="py-2 px-2">Kd RUP</th>
                  <th class="py-2 px-2">Nama Paket</th>
                  <th
                    class="py-2 px-2 cursor-pointer"
                    @click="sortTable('pagu')"
                  >
                    Pagu
                    <span v-if="sortField === 'pagu'">
                      {{ sortOrder === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <th class="py-2 px-2">Metode</th>
                  <th class="py-2 px-2">Jenis</th>
                  <th
                    class="py-2 px-2 cursor-pointer"
                    @click="sortTable('nontender_pagu')"
                  >
                    Pagu (NT)
                    <span v-if="sortField === 'nontender_pagu'">
                      {{ sortOrder === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <th
                    class="py-2 px-2 cursor-pointer"
                    @click="sortTable('nontender_realisasi')"
                  >
                    Realisasi (NT)
                    <span v-if="sortField === 'nontender_realisasi'">
                      {{ sortOrder === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                  <th
                    class="py-2 px-2 cursor-pointer"
                    @click="sortTable('status')"
                  >
                    Status
                    <span v-if="sortField === 'status'">
                      {{ sortOrder === 'asc' ? '▲' : '▼' }}
                    </span>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr
                  v-for="item in paginatedSortedNonTenderData"
                  :key="item.kd_rup + '_' + item.kd_satker_str"
                  class="border-b last:border-0"
                >
                  <td class="py-2 px-2">{{ item.tahun_anggaran }}</td>
                  <td class="py-2 px-2">{{ item.kd_satker_str }}</td>
                  <td class="py-2 px-2">{{ item.nama_satker }}</td>
                  <td class="py-2 px-2">{{ item.kd_rup }}</td>
                  <td class="py-2 px-2">{{ item.nama_paket }}</td>
                  <td class="py-2 px-2 text-right">
                    <!-- Pagu => IDR currency -->
                    {{ formatRupiah(item.pagu) }}
                  </td>
                  <td class="py-2 px-2">{{ item.metode_pengadaan }}</td>
                  <td class="py-2 px-2">{{ item.jenis_pengadaan }}</td>
                  <td class="py-2 px-2 text-right">
                    {{ formatRupiah(item.nontender_pagu) }}
                  </td>
                  <td class="py-2 px-2 text-right">
                    {{ formatRupiah(item.nontender_realisasi) }}
                  </td>
                  <td class="py-2 px-2">{{ formatStatus(item.status) }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination Controls -->
          <div
            class="flex flex-col md:flex-row md:items-center md:justify-between mt-4 text-sm"
          >
            <div class="mb-2 md:mb-0">
              Showing
              <span class="font-semibold">
                {{ (currentPage - 1) * pageSize + 1 }}
              </span>
              to
              <span class="font-semibold">
                {{ Math.min(currentPage * pageSize,
                filteredNonTenderData.length) }}
              </span>
              of
              <span class="font-semibold"
                >{{ filteredNonTenderData.length }}</span
              >
              entries
            </div>
            <div class="space-x-2">
              <button
                class="px-3 py-1 text-sm border border-gray-300 rounded disabled:opacity-50"
                :disabled="currentPage === 1"
                @click="prevPage"
              >
                Prev
              </button>
              <button
                class="px-3 py-1 text-sm border border-gray-300 rounded disabled:opacity-50"
                :disabled="currentPage * pageSize >= filteredNonTenderData.length"
                @click="nextPage"
              >
                Next
              </button>
            </div>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer class="bg-white border-t mt-6">
        <div
          class="container mx-auto px-4 py-3 text-center text-xs text-gray-400"
        >
          &copy; {{ new Date().getFullYear() }} - Demo Kemenlu Dashboard
        </div>
      </footer>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            isLoading: false,

            // Raw data from first API
            satkerData: [],
            // Raw data from second API
            nonTenderData: [],

            // Filters
            selectedPusatPerwakilan: "",
            selectedSatkerAlias: "",
            selectedStatus: "", // 0=Belum,1=Sudah

            // Sorting
            sortField: "",
            sortOrder: "asc",

            // Pagination
            currentPage: 1,
            pageSize: 10,
          };
        },
        computed: {
          // Distinct "pusat_perwakilan"
          uniquePusatPerwakilan() {
            const set = new Set();
            this.satkerData.forEach((row) => {
              set.add(row.pusat_perwakilan);
            });
            return [...set].sort();
          },

          // Distinct "satker_alias" for datalist
          uniqueSatkerAliases() {
            const set = new Set();
            this.satkerData.forEach((row) => {
              if (row.satker_alias) {
                set.add(row.satker_alias);
              }
            });
            return [...set].sort();
          },

          // Filtered data from first API
          filteredSatkerData() {
            return this.satkerData.filter((row) => {
              // Filter by pusat_perwakilan
              if (this.selectedPusatPerwakilan) {
                if (row.pusat_perwakilan !== this.selectedPusatPerwakilan) {
                  return false;
                }
              }
              // Filter by satker_alias if input is not empty
              if (this.selectedSatkerAlias) {
                if (row.satker_alias !== this.selectedSatkerAlias) {
                  return false;
                }
              }
              return true;
            });
          },

          // Filter second API data based on filteredSatkerData
          filteredNonTenderData() {
            // Build set of allowed kd_satker_str
            const allowed = new Set(
              this.filteredSatkerData.map((x) => String(x.kd_satker_str))
            );
            // base filter
            let data = this.nonTenderData.filter((detail) =>
              allowed.has(String(detail.kd_satker_str))
            );
            // filter status if selected
            if (this.selectedStatus !== "") {
              data = data.filter(
                (row) => String(row.status) === String(this.selectedStatus)
              );
            }
            return data;
          },

          // Card #1: sum of status_nontender
          cardTotalTercatat() {
            return this.filteredSatkerData.reduce(
              (acc, cur) => acc + (cur.status_nontender || 0),
              0
            );
          },
          // Card #2: sum of rup_nontender (thousand separated)
          cardTotalPaketSirup() {
            return this.filteredSatkerData.reduce(
              (acc, cur) => acc + (cur.rup_nontender || 0),
              0
            );
          },
          // Card #3: average persentase_nontender => show in percent
          cardRataPersentase() {
            if (!this.filteredSatkerData.length) return 0;
            const sum = this.filteredSatkerData.reduce(
              (acc, cur) => acc + (cur.persentase_nontender || 0),
              0
            );
            const avg = sum / this.filteredSatkerData.length;
            return (avg * 100).toFixed(2);
          },
          // Card #4: sum nontender_pagu => IDR
          cardPaguSirup() {
            return this.filteredNonTenderData.reduce(
              (acc, cur) => acc + (Number(cur.nontender_pagu) || 0),
              0
            );
          },
          // Card #5: sum nontender_realisasi => IDR
          cardPaguRealisasi() {
            return this.filteredNonTenderData.reduce(
              (acc, cur) => acc + (Number(cur.nontender_realisasi) || 0),
              0
            );
          },

          // Top 5 satker by avg. persentase
          topSatker() {
            const map = {};
            this.filteredSatkerData.forEach((row) => {
              const key = row.satker_alias || "(Unknown)";
              if (!map[key]) map[key] = { sum: 0, count: 0 };
              map[key].sum += row.persentase_nontender || 0;
              map[key].count++;
            });
            const arr = Object.keys(map).map((k) => ({
              key: k,
              avg: map[k].sum / map[k].count || 0,
            }));
            arr.sort((a, b) => b.avg - a.avg);
            return arr.slice(0, 5);
          },
          // Top 5 country
          topCountries() {
            const map = {};
            this.filteredSatkerData.forEach((row) => {
              const c = row.country || "(Unknown)";
              if (!map[c]) map[c] = { sum: 0, count: 0 };
              map[c].sum += row.persentase_nontender || 0;
              map[c].count++;
            });
            const arr = Object.keys(map).map((k) => ({
              key: k,
              avg: map[k].sum / map[k].count || 0,
            }));
            arr.sort((a, b) => b.avg - a.avg);
            return arr.slice(0, 5);
          },
          // Top 5 region
          topRegions() {
            const map = {};
            this.filteredSatkerData.forEach((row) => {
              const r = row.region || "(Unknown)";
              if (!map[r]) map[r] = { sum: 0, count: 0 };
              map[r].sum += row.persentase_nontender || 0;
              map[r].count++;
            });
            const arr = Object.keys(map).map((k) => ({
              key: k,
              avg: map[k].sum / map[k].count || 0,
            }));
            arr.sort((a, b) => b.avg - a.avg);
            return arr.slice(0, 5);
          },

          // Sorting and pagination for second API
          sortedNonTenderData() {
            const arr = [...this.filteredNonTenderData];
            if (this.sortField) {
              arr.sort((a, b) => {
                const valA = a[this.sortField];
                const valB = b[this.sortField];
                if (valA === valB) return 0;
                if (this.sortOrder === "asc") return valA > valB ? 1 : -1;
                else return valA < valB ? 1 : -1;
              });
            }
            return arr;
          },
          paginatedSortedNonTenderData() {
            const start = (this.currentPage - 1) * this.pageSize;
            const end = start + this.pageSize;
            return this.sortedNonTenderData.slice(start, end);
          },
        },
        methods: {
          // Sorting
          sortTable(field) {
            if (this.sortField === field) {
              this.sortOrder = this.sortOrder === "asc" ? "desc" : "asc";
            } else {
              this.sortField = field;
              this.sortOrder = "asc";
            }
          },
          // Pagination
          nextPage() {
            if (
              this.currentPage * this.pageSize <
              this.filteredNonTenderData.length
            ) {
              this.currentPage++;
            }
          },
          prevPage() {
            if (this.currentPage > 1) {
              this.currentPage--;
            }
          },

          // Format numbers
          formatNumber(val) {
            if (!val) val = 0;
            return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          },
          formatRupiah(val) {
            if (!val) val = 0;
            const s = val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return `Rp. ${s},-`;
          },
          formatStatus(st) {
            if (st === 0) return "Belum";
            if (st === 1) return "Sudah";
            return st;
          },

          // Data fetching
          async fetchSatkerData() {
            const url =
              "https://script.google.com/macros/s/AKfycbyYPjKN56a9EHp2JO2Jwo2HWoeWa1oFbmeH2XuDCxKQ8_YWzP12RNP9gXv7mK36p2vG/exec";
            const resp = await fetch(url);
            const json = await resp.json();
            if (json && json.data) {
              this.satkerData = json.data;
            }
          },
          async fetchNonTenderData() {
            const url =
              "https://script.google.com/macros/s/AKfycbz45Y22xXN8mRVFVHcdduXytGOh9CfoqrVN9u7mMFSgrgNobLbh3mJAXazQBeK42Hi-/exec";
            const resp = await fetch(url);
            const json = await resp.json();
            if (json && json.data) {
              this.nonTenderData = json.data.map((d) => ({
                tahun_anggaran: d.tahun_anggaran,
                kd_satker_str: d.kd_satker_str,
                nama_satker: d.nama_satker,
                kd_rup: d.kd_rup,
                nama_paket: d.nama_paket,
                pagu: d.pagu,
                metode_pengadaan: d.metode_pengadaan,
                jenis_pengadaan: d.jenis_pengadaan,
                nontender_pagu: d.nontender_pagu,
                nontender_realisasi: d.nontender_realisasi,
                status: d.status,
              }));
            }
          },

          // localStorage caching
          loadCache() {
            try {
              const satkerCache = localStorage.getItem("satkerData");
              const nonTenderCache = localStorage.getItem("nonTenderData");
              if (satkerCache) {
                this.satkerData = JSON.parse(satkerCache);
              }
              if (nonTenderCache) {
                this.nonTenderData = JSON.parse(nonTenderCache);
              }
            } catch (e) {
              console.warn("Failed to load from cache", e);
            }
          },
          saveCache() {
            try {
              localStorage.setItem(
                "satkerData",
                JSON.stringify(this.satkerData)
              );
              localStorage.setItem(
                "nonTenderData",
                JSON.stringify(this.nonTenderData)
              );
            } catch (e) {
              console.warn("Failed to save to cache", e);
            }
          },
        },
        async mounted() {
          // load from cache
          this.loadCache();

          // fetch data
          this.isLoading = true;
          try {
            await this.fetchSatkerData();
            await this.fetchNonTenderData();
          } catch (err) {
            console.error("Error fetching data", err);
          } finally {
            this.isLoading = false;
          }

          // update cache
          this.saveCache();
        },
        watch: {
          // reset pagination on filter changes
          pageSize() {
            this.currentPage = 1;
          },
          selectedPusatPerwakilan() {
            this.currentPage = 1;
          },
          selectedSatkerAlias() {
            this.currentPage = 1;
          },
          selectedStatus() {
            this.currentPage = 1;
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
