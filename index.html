<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <title>Kemenlu Data - Full Enhanced</title>

    <!-- Favicon -->
    <link
      rel="icon"
      href="https://lh3.googleusercontent.com/d/1YJ5QUeb-ekUYZbXIK_WuBWNi-RvhC40o"
      type="image/png"
    />

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Minimal inline Tailwind config (optional) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              kemenlu: {
                navy: {
                  500: "#3C59A7",
                },
                red: {
                  500: "#EF4444",
                },
                gold: {
                  500: "#F59E0B",
                },
                green: {
                  500: "#22C55E",
                },
              },
              border: "hsl(var(--border))",
              input: "hsl(var(--input))",
              ring: "hsl(var(--ring))",
              background: "hsl(var(--background))",
              foreground: "hsl(var(--foreground))",
              primary: {
                DEFAULT: "hsl(var(--primary))",
                foreground: "hsl(var(--primary-foreground))",
              },
              secondary: {
                DEFAULT: "hsl(var(--secondary))",
                foreground: "hsl(var(--secondary-foreground))",
              },
            },
          },
        },
      };
    </script>

    <!-- Vue 3 (standalone) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  </head>

  <body class="min-h-screen bg-gray-50 font-sans antialiased">
    <div id="app" class="relative min-h-screen flex flex-col">
      <!-- Navbar - Shadcn-inspired styling -->
      <!--
      <nav
        class="sticky top-0 z-50 w-full border-b bg-white/95 backdrop-blur supports-[backdrop-filter]:bg-white/60"
      -->
        <div class="container flex h-14 items-center justify-between px-4">
          <!-- Left: Logo & Title with improved spacing and alignment -->
          <div class="flex items-center gap-4">
            <img
              src="https://lh3.googleusercontent.com/d/1NY5Ncxw9q2zWS5OH2QAMVbkzKDJT4wl0"
              alt="Kemenlu Logo"
              class="h-8 w-8 rounded-sm object-contain"
            />
            <h1 class="text-lg font-semibold tracking-tight text-gray-900">
              Kemenlu Data Dashboard
            </h1>
          </div>

          <!-- Right: Loading Indicator with improved animation -->
          <div v-if="isLoading" class="flex items-center gap-2">
            <svg
              class="h-4 w-4 animate-spin text-gray-600"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v8H4z"
              ></path>
            </svg>
            <span class="text-sm text-gray-600 font-medium"
              >Fetching Data...</span
            >
          </div>
        </div>
      </nav>
    -
      <!-- Main Content -->
      <main class="flex-1 container px-4 py-6">
        <!-- Filters with shadcn-inspired styling -->
        <div class="rounded-lg border bg-card shadow-sm p-6 mb-6">
          <div class="flex flex-col lg:flex-row gap-6">
            <!-- Dropdown Filter for pusat_perwakilan -->
            <div class="w-full lg:w-1/4">
              <label
                for="pusatFilter"
                class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 mb-2 block"
                >Filter Pusat/Perwakilan</label
              >
              <select
                id="pusatFilter"
                v-model="selectedPusatPerwakilan"
                class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
              >
                <option value="">All</option>
                <option
                  v-for="(val, idx) in uniquePusatPerwakilan"
                  :key="idx"
                  :value="val"
                >
                  {{ val }}
                </option>
              </select>
            </div>

            <!-- Searchable dropdown for satker_alias -->
            <div class="w-full lg:w-1/4">
              <label
                for="satkerAliasInput"
                class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 mb-2 block"
                >Satker</label
              >
              <input
                type="text"
                id="satkerAliasInput"
                list="satkerAliasList"
                v-model="selectedSatkerAlias"
                placeholder="Type alias or choose"
                class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
              />
              <datalist id="satkerAliasList">
                <option value="">All</option>
                <option
                  v-for="(alias, idx) in uniqueSatkerAliases"
                  :key="idx"
                  :value="alias"
                />
              </datalist>
            </div>

            <!-- Status filter -->
            <div class="w-full lg:w-1/4">
              <label
                for="statusFilter"
                class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 mb-2 block"
                >Status Pencatatan</label
              >
              <select
                id="statusFilter"
                v-model="selectedStatus"
                class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
              >
                <option value="">All</option>
                <option value="0">Belum</option>
                <option value="1">Sudah</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Cards (Summary) with shadcn-style grid layout -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
          <!-- Total Tercatat -->
          <div
            class="rounded-lg border bg-card text-card-foreground shadow-sm p-6 flex flex-col justify-between"
          >
            <span class="text-sm font-medium text-muted-foreground">
              Total Tercatat
            </span>
            <span class="text-2xl font-bold tracking-tight">
              {{ cardTotalTercatat }}
            </span>
          </div>

          <!-- Total Paket SIRUP -->
          <div
            class="rounded-lg border bg-card text-card-foreground shadow-sm p-6 flex flex-col justify-between"
          >
            <span class="text-sm font-medium text-muted-foreground">
              Total Paket SIRUP
            </span>
            <span class="text-2xl font-bold tracking-tight">
              {{ formatNumber(cardTotalPaketSirup) }}
            </span>
          </div>

          <!-- Rata-rata Persentase -->
          <div
            class="rounded-lg border bg-card text-card-foreground shadow-sm p-6 flex flex-col justify-between"
          >
            <span class="text-sm font-medium text-muted-foreground">
              Rata-rata Persentase
            </span>
            <span class="text-2xl font-bold tracking-tight">
              {{ cardRataPersentase }}%
            </span>
          </div>

          <!-- Pagu SIRUP -->
          <div
            class="rounded-lg border bg-card text-card-foreground shadow-sm p-6 flex flex-col justify-between"
          >
            <span class="text-sm font-medium text-muted-foreground">
              Pagu SiRUP
            </span>
            <span class="text-2xl font-bold tracking-tight">
              {{ formatRupiah(cardPaguSirup) }}
            </span>
          </div>

          <!-- Pagu Realisasi -->
          <div
            class="rounded-lg border bg-card text-card-foreground shadow-sm p-6 flex flex-col justify-between"
          >
            <span class="text-sm font-medium text-muted-foreground">
              Pagu Realisasi
            </span>
            <span class="text-2xl font-bold tracking-tight">
              {{ formatRupiah(cardPaguRealisasi) }}
            </span>
          </div>
        </div>

        <!-- Top 5 (Satker, Country, Region) with shadcn-inspired styling -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
          <!-- Top 5 Satker by Average Percentage -->
          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="p-6">
              <h2
                class="text-lg font-semibold leading-none tracking-tight mb-4"
              >
                Top 5 Satker by %
              </h2>
              <div class="relative w-full overflow-auto">
                <table class="w-full caption-bottom text-sm">
                  <thead class="[&_tr]:border-b">
                    <tr
                      class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted"
                    >
                      <th
                        class="h-10 px-2 text-left align-middle font-medium text-muted-foreground"
                      >
                        Satker Alias
                      </th>
                      <th
                        class="h-10 px-2 text-right align-middle font-medium text-muted-foreground"
                      >
                        Avg. %
                      </th>
                    </tr>
                  </thead>
                  <tbody class="[&_tr:last-child]:border-0">
                    <tr
                      v-for="(item, index) in topSatker"
                      :key="index"
                      class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted"
                    >
                      <td class="p-2 align-middle">{{ item.key }}</td>
                      <td class="p-2 align-middle text-right">
                        {{ (item.avg * 100).toFixed(2) }}%
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Top 5 Country by Average Percentage -->
          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="p-6">
              <h2
                class="text-lg font-semibold leading-none tracking-tight mb-4"
              >
                Top 5 Country by %
              </h2>
              <div class="relative w-full overflow-auto">
                <table class="w-full caption-bottom text-sm">
                  <thead class="[&_tr]:border-b">
                    <tr
                      class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted"
                    >
                      <th
                        class="h-10 px-2 text-left align-middle font-medium text-muted-foreground"
                      >
                        Country
                      </th>
                      <th
                        class="h-10 px-2 text-right align-middle font-medium text-muted-foreground"
                      >
                        Avg. %
                      </th>
                    </tr>
                  </thead>
                  <tbody class="[&_tr:last-child]:border-0">
                    <tr
                      v-for="(item, index) in topCountries"
                      :key="index"
                      class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted"
                    >
                      <td class="p-2 align-middle">{{ item.key }}</td>
                      <td class="p-2 align-middle text-right">
                        {{ (item.avg * 100).toFixed(2) }}%
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Top 5 Region by Average Percentage -->
          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="p-6">
              <h2
                class="text-lg font-semibold leading-none tracking-tight mb-4"
              >
                Top 5 Region by %
              </h2>
              <div class="relative w-full overflow-auto">
                <table class="w-full caption-bottom text-sm">
                  <thead class="[&_tr]:border-b">
                    <tr
                      class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted"
                    >
                      <th
                        class="h-10 px-2 text-left align-middle font-medium text-muted-foreground"
                      >
                        Region
                      </th>
                      <th
                        class="h-10 px-2 text-right align-middle font-medium text-muted-foreground"
                      >
                        Avg. %
                      </th>
                    </tr>
                  </thead>
                  <tbody class="[&_tr:last-child]:border-0">
                    <tr
                      v-for="(item, index) in topRegions"
                      :key="index"
                      class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted"
                    >
                      <td class="p-2 align-middle">{{ item.key }}</td>
                      <td class="p-2 align-middle text-right">
                        {{ (item.avg * 100).toFixed(2) }}%
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- Paginated, Sortable Table & Export -->
        <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
          <div class="p-6">
            <!-- Table Header Controls -->
            <div
              class="flex flex-col space-y-4 md:flex-row md:items-center md:justify-between md:space-y-0 mb-6"
            >
              <h2 class="text-lg font-semibold leading-none tracking-tight">
                NonTender Detail Table
              </h2>

              <div class="flex flex-wrap items-center gap-4">
                <!-- Page size selection -->
                <div class="flex items-center space-x-2">
                  <label for="pageSize" class="text-sm font-medium leading-none"
                    >Rows per page:</label
                  >
                  <select
                    id="pageSize"
                    v-model.number="pageSize"
                    class="flex h-9 w-[70px] rounded-md border border-input bg-transparent px-3 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
                  >
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                  </select>
                </div>

                <!-- Export button -->
                <button
                  @click="exportFilteredTable"
                  class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2"
                >
                  Export (All Filtered) CSV
                </button>
              </div>
            </div>

            <!-- Table Container -->
            <div class="relative w-full overflow-auto">
              <table class="w-full caption-bottom text-sm">
                <thead class="[&_tr]:border-b bg-muted/50">
                  <tr
                    class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted"
                  >
                    <!-- Table Headers -->
                    <th
                      class="h-10 px-2 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground"
                      @click="sortTable('tahun_anggaran')"
                    >
                      <div class="flex items-center space-x-1">
                        <span>Tahun</span>
                        <span
                          v-if="sortField === 'tahun_anggaran'"
                          class="text-xs"
                        >
                          {{ sortOrder === 'asc' ? '▲' : '▼' }}
                        </span>
                      </div>
                    </th>

                    <th
                      class="h-10 px-2 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground"
                      @click="sortTable('kd_satker_str')"
                    >
                      <div class="flex items-center space-x-1">
                        <span>Kd Satker</span>
                        <span
                          v-if="sortField === 'kd_satker_str'"
                          class="text-xs"
                        >
                          {{ sortOrder === 'asc' ? '▲' : '▼' }}
                        </span>
                      </div>
                    </th>

                    <th
                      class="h-10 px-2 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground"
                      @click="sortTable('nama_satker')"
                    >
                      <div class="flex items-center space-x-1">
                        <span>Nama Satker</span>
                        <span
                          v-if="sortField === 'nama_satker'"
                          class="text-xs"
                        >
                          {{ sortOrder === 'asc' ? '▲' : '▼' }}
                        </span>
                      </div>
                    </th>

                    <th
                      class="h-10 px-2 text-left align-middle font-medium text-muted-foreground"
                    >
                      Kd RUP
                    </th>

                    <th
                      class="h-10 px-2 text-left align-middle font-medium text-muted-foreground"
                    >
                      Nama Paket
                    </th>

                    <th
                      class="h-10 px-2 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground"
                      @click="sortTable('pagu')"
                    >
                      <div class="flex items-center space-x-1">
                        <span>Pagu</span>
                        <span v-if="sortField === 'pagu'" class="text-xs">
                          {{ sortOrder === 'asc' ? '▲' : '▼' }}
                        </span>
                      </div>
                    </th>

                    <th
                      class="h-10 px-2 text-left align-middle font-medium text-muted-foreground"
                    >
                      Metode
                    </th>

                    <th
                      class="h-10 px-2 text-left align-middle font-medium text-muted-foreground"
                    >
                      Jenis
                    </th>

                    <th
                      class="h-10 px-2 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground"
                      @click="sortTable('nontender_pagu')"
                    >
                      <div class="flex items-center space-x-1">
                        <span>Pagu (NT)</span>
                        <span
                          v-if="sortField === 'nontender_pagu'"
                          class="text-xs"
                        >
                          {{ sortOrder === 'asc' ? '▲' : '▼' }}
                        </span>
                      </div>
                    </th>

                    <th
                      class="h-10 px-2 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground"
                      @click="sortTable('nontender_realisasi')"
                    >
                      <div class="flex items-center space-x-1">
                        <span>Realisasi (NT)</span>
                        <span
                          v-if="sortField === 'nontender_realisasi'"
                          class="text-xs"
                        >
                          {{ sortOrder === 'asc' ? '▲' : '▼' }}
                        </span>
                      </div>
                    </th>

                    <th
                      class="h-10 px-2 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground"
                      @click="sortTable('status')"
                    >
                      <div class="flex items-center space-x-1">
                        <span>Status</span>
                        <span v-if="sortField === 'status'" class="text-xs">
                          {{ sortOrder === 'asc' ? '▲' : '▼' }}
                        </span>
                      </div>
                    </th>
                  </tr>
                </thead>
                <!-- Table Body -->
                <tbody class="[&_tr:last-child]:border-0">
                  <tr
                    v-for="item in paginatedSortedNonTenderData"
                    :key="item.kd_rup + '_' + item.kd_satker_str"
                    class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted"
                  >
                    <td class="p-2 align-middle">{{ item.tahun_anggaran }}</td>
                    <td class="p-2 align-middle">{{ item.kd_satker_str }}</td>
                    <td class="p-2 align-middle">{{ item.nama_satker }}</td>
                    <td class="p-2 align-middle">{{ item.kd_rup }}</td>
                    <td class="p-2 align-middle">{{ item.nama_paket }}</td>
                    <td class="p-2 align-middle text-right">
                      {{ formatRupiah(item.pagu) }}
                    </td>
                    <td class="p-2 align-middle">
                      {{ item.metode_pengadaan }}
                    </td>
                    <td class="p-2 align-middle">{{ item.jenis_pengadaan }}</td>
                    <td class="p-2 align-middle text-right">
                      {{ formatRupiah(item.nontender_pagu) }}
                    </td>
                    <td class="p-2 align-middle text-right">
                      {{ formatRupiah(item.nontender_realisasi) }}
                    </td>
                    <td class="p-2 align-middle">
                      <span
                        class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset"
                        :class="{
                  'bg-green-50 text-green-700 ring-green-600/20': item.status === 1,
                  'bg-yellow-50 text-yellow-700 ring-yellow-600/20': item.status === 0
                }"
                      >
                        {{ formatStatus(item.status) }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination Controls -->
            <div
              class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 mt-4 px-2"
            >
              <div class="text-sm text-muted-foreground">
                Showing
                <span class="font-medium"
                  >{{ (currentPage - 1) * pageSize + 1 }}</span
                >
                to
                <span class="font-medium">
                  {{ Math.min(currentPage * pageSize,
                  filteredNonTenderData.length) }}
                </span>
                of
                <span class="font-medium"
                  >{{ filteredNonTenderData.length }}</span
                >
                entries
              </div>

              <div class="flex items-center space-x-2">
                <button
                  class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2"
                  :disabled="currentPage === 1"
                  @click="prevPage"
                >
                  Previous
                </button>
                <button
                  class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2"
                  :disabled="currentPage * pageSize >= filteredNonTenderData.length"
                  @click="nextPage"
                >
                  Next
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer
        class="border-t bg-white/95 backdrop-blur supports-[backdrop-filter]:bg-white/60"
      >
        <div class="container flex h-14 items-center justify-center">
          <p class="text-sm text-muted-foreground">
            &copy; {{ new Date().getFullYear() }} - SI PBJ Dashboard
          </p>
        </div>
      </footer>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            isLoading: false,

            // Raw data from first API
            satkerData: [],
            // Raw data from second API
            nonTenderData: [],

            // Filters
            selectedPusatPerwakilan: "",
            selectedSatkerAlias: "",
            selectedStatus: "", // 0=Belum,1=Sudah

            // Sorting
            sortField: "",
            sortOrder: "asc",

            // Pagination
            currentPage: 1,
            pageSize: 10,
          };
        },
        computed: {
          // Distinct "pusat_perwakilan"
          uniquePusatPerwakilan() {
            const set = new Set();
            this.satkerData.forEach((row) => {
              set.add(row.pusat_perwakilan);
            });
            return [...set].sort();
          },

          // Distinct "satker_alias" for datalist
          uniqueSatkerAliases() {
            const set = new Set();
            this.satkerData.forEach((row) => {
              if (row.satker_alias) {
                set.add(row.satker_alias);
              }
            });
            return [...set].sort();
          },

          // Filtered data from first API
          filteredSatkerData() {
            return this.satkerData.filter((row) => {
              // Filter by pusat_perwakilan
              if (this.selectedPusatPerwakilan) {
                if (row.pusat_perwakilan !== this.selectedPusatPerwakilan) {
                  return false;
                }
              }
              // Filter by satker_alias if input is not empty
              if (this.selectedSatkerAlias) {
                // If user typed or selected an alias from the list
                if (row.satker_alias !== this.selectedSatkerAlias) {
                  return false;
                }
              }
              return true;
            });
          },

          // Filter second API data based on filteredSatkerData
          filteredNonTenderData() {
            // Build set of allowed kd_satker_str
            const allowed = new Set(
              this.filteredSatkerData.map((x) => String(x.kd_satker_str))
            );
            // base filter
            let data = this.nonTenderData.filter((detail) =>
              allowed.has(String(detail.kd_satker_str))
            );
            // filter status if selected
            if (this.selectedStatus !== "") {
              data = data.filter(
                (row) => String(row.status) === String(this.selectedStatus)
              );
            }
            return data;
          },

          // Card #1: sum of status_nontender
          cardTotalTercatat() {
            return this.filteredSatkerData.reduce(
              (acc, cur) => acc + (cur.status_nontender || 0),
              0
            );
          },
          // Card #2: sum of rup_nontender (thousand separated)
          cardTotalPaketSirup() {
            return this.filteredSatkerData.reduce(
              (acc, cur) => acc + (cur.rup_nontender || 0),
              0
            );
          },
          // Card #3: average persentase_nontender => show in percent
          cardRataPersentase() {
            if (!this.filteredSatkerData.length) return 0;
            const sum = this.filteredSatkerData.reduce(
              (acc, cur) => acc + (cur.persentase_nontender || 0),
              0
            );
            const avg = sum / this.filteredSatkerData.length;
            return (avg * 100).toFixed(2);
          },
          // Card #4: sum nontender_pagu => IDR
          cardPaguSirup() {
            return this.filteredNonTenderData.reduce(
              (acc, cur) => acc + (Number(cur.nontender_pagu) || 0),
              0
            );
          },
          // Card #5: sum nontender_realisasi => IDR
          cardPaguRealisasi() {
            return this.filteredNonTenderData.reduce(
              (acc, cur) => acc + (Number(cur.nontender_realisasi) || 0),
              0
            );
          },

          // Top 5 satker by avg. persentase
          topSatker() {
            const map = {};
            this.filteredSatkerData.forEach((row) => {
              const key = row.satker_alias || "(Unknown)";
              if (!map[key]) map[key] = { sum: 0, count: 0 };
              map[key].sum += row.persentase_nontender || 0;
              map[key].count++;
            });
            const arr = Object.keys(map).map((k) => ({
              key: k,
              avg: map[k].count ? map[k].sum / map[k].count : 0,
            }));
            arr.sort((a, b) => b.avg - a.avg);
            return arr.slice(0, 5);
          },
          // Top 5 country
          topCountries() {
            const map = {};
            this.filteredSatkerData.forEach((row) => {
              const c = row.country || "(Unknown)";
              if (!map[c]) map[c] = { sum: 0, count: 0 };
              map[c].sum += row.persentase_nontender || 0;
              map[c].count++;
            });
            const arr = Object.keys(map).map((k) => ({
              key: k,
              avg: map[k].count ? map[k].sum / map[k].count : 0,
            }));
            arr.sort((a, b) => b.avg - a.avg);
            return arr.slice(0, 5);
          },
          // Top 5 region
          topRegions() {
            const map = {};
            this.filteredSatkerData.forEach((row) => {
              const r = row.region || "(Unknown)";
              if (!map[r]) map[r] = { sum: 0, count: 0 };
              map[r].sum += row.persentase_nontender || 0;
              map[r].count++;
            });
            const arr = Object.keys(map).map((k) => ({
              key: k,
              avg: map[k].count ? map[k].sum / map[k].count : 0,
            }));
            arr.sort((a, b) => b.avg - a.avg);
            return arr.slice(0, 5);
          },

          // Sorting and pagination for second API
          sortedNonTenderData() {
            // We want the entire set (no pagination) for the export
            const arr = [...this.filteredNonTenderData];
            if (this.sortField) {
              arr.sort((a, b) => {
                const valA = a[this.sortField];
                const valB = b[this.sortField];
                if (valA === valB) return 0;
                if (this.sortOrder === "asc") return valA > valB ? 1 : -1;
                else return valA < valB ? 1 : -1;
              });
            }
            return arr;
          },
          // The data actually displayed on the table (paged subset)
          paginatedSortedNonTenderData() {
            const start = (this.currentPage - 1) * this.pageSize;
            const end = start + this.pageSize;
            return this.sortedNonTenderData.slice(start, end);
          },
        },
        methods: {
          // Sorting
          sortTable(field) {
            if (this.sortField === field) {
              this.sortOrder = this.sortOrder === "asc" ? "desc" : "asc";
            } else {
              this.sortField = field;
              this.sortOrder = "asc";
            }
          },
          // Pagination
          nextPage() {
            if (
              this.currentPage * this.pageSize <
              this.filteredNonTenderData.length
            ) {
              this.currentPage++;
            }
          },
          prevPage() {
            if (this.currentPage > 1) {
              this.currentPage--;
            }
          },

          // Convert 123456 => "123,456"
          formatNumber(num) {
            if (!num) num = 0;
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          },
          // Convert 123456 => "Rp. 123,456,-"
          formatRupiah(num) {
            if (!num) num = 0;
            const s = num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return `Rp. ${s},-`;
          },
          // Format status
          formatStatus(st) {
            if (st === 0) return "Belum";
            if (st === 1) return "Sudah";
            return st;
          },

          // Data fetching
          async fetchSatkerData() {
            const url =
              "https://script.google.com/macros/s/AKfycbyYPjKN56a9EHp2JO2Jwo2HWoeWa1oFbmeH2XuDCxKQ8_YWzP12RNP9gXv7mK36p2vG/exec";
            const resp = await fetch(url);
            const json = await resp.json();
            if (json && json.data) {
              this.satkerData = json.data;
            }
          },
          async fetchNonTenderData() {
            const url =
              "https://script.google.com/macros/s/AKfycbz45Y22xXN8mRVFVHcdduXytGOh9CfoqrVN9u7mMFSgrgNobLbh3mJAXazQBeK42Hi-/exec";
            const resp = await fetch(url);
            const json = await resp.json();
            if (json && json.data) {
              this.nonTenderData = json.data.map((d) => ({
                tahun_anggaran: d.tahun_anggaran,
                kd_satker_str: d.kd_satker_str,
                nama_satker: d.nama_satker,
                kd_rup: d.kd_rup,
                nama_paket: d.nama_paket,
                pagu: d.pagu,
                metode_pengadaan: d.metode_pengadaan,
                jenis_pengadaan: d.jenis_pengadaan,
                nontender_pagu: d.nontender_pagu,
                nontender_realisasi: d.nontender_realisasi,
                status: d.status,
              }));
            }
          },

          // Export filtered data (ignoring pagination) to CSV
          exportFilteredTable() {
            // We'll use sortedNonTenderData so it respects current sorting + filters
            const dataToExport = this.sortedNonTenderData;

            if (!dataToExport.length) {
              alert("No data to export!");
              return;
            }

            // Build CSV string
            // Include header row
            const header = [
              "tahun_anggaran",
              "kd_satker_str",
              "nama_satker",
              "kd_rup",
              "nama_paket",
              "pagu",
              "metode_pengadaan",
              "jenis_pengadaan",
              "nontender_pagu",
              "nontender_realisasi",
              "status",
            ];
            const csvRows = [];
            csvRows.push(header.join(",")); // header line

            dataToExport.forEach((item) => {
              // Convert each item to a row
              // Format or keep raw? We'll keep raw numeric forms
              const row = [
                item.tahun_anggaran,
                item.kd_satker_str,
                // For CSV safety, wrap strings with quotes if needed
                `"${(item.nama_satker || "").replace(/"/g, '""')}"`,
                item.kd_rup,
                `"${(item.nama_paket || "").replace(/"/g, '""')}"`,
                item.pagu,
                `"${(item.metode_pengadaan || "").replace(/"/g, '""')}"`,
                `"${(item.jenis_pengadaan || "").replace(/"/g, '""')}"`,
                item.nontender_pagu,
                item.nontender_realisasi,
                item.status,
              ];
              csvRows.push(row.join(","));
            });

            const csvContent = csvRows.join("\n");

            // Create a Blob
            const blob = new Blob([csvContent], {
              type: "text/csv;charset=utf-8;",
            });
            // Create a temporary link
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "export_filtered_nontender.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          },

          // localStorage caching
          loadCache() {
            try {
              const satkerCache = localStorage.getItem("satkerData");
              const nonTenderCache = localStorage.getItem("nonTenderData");
              if (satkerCache) {
                this.satkerData = JSON.parse(satkerCache);
              }
              if (nonTenderCache) {
                this.nonTenderData = JSON.parse(nonTenderCache);
              }
            } catch (e) {
              console.warn("Failed to load from cache", e);
            }
          },
          saveCache() {
            try {
              localStorage.setItem(
                "satkerData",
                JSON.stringify(this.satkerData)
              );
              localStorage.setItem(
                "nonTenderData",
                JSON.stringify(this.nonTenderData)
              );
            } catch (e) {
              console.warn("Failed to save to cache", e);
            }
          },
        },
        async mounted() {
          // load from cache
          this.loadCache();

          // fetch data
          this.isLoading = true;
          try {
            await this.fetchSatkerData();
            await this.fetchNonTenderData();
          } catch (err) {
            console.error("Error fetching data", err);
          } finally {
            this.isLoading = false;
          }

          // update cache
          this.saveCache();
        },
        watch: {
          // reset pagination on filter changes
          pageSize() {
            this.currentPage = 1;
          },
          selectedPusatPerwakilan() {
            this.currentPage = 1;
          },
          selectedSatkerAlias() {
            this.currentPage = 1;
          },
          selectedStatus() {
            this.currentPage = 1;
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
